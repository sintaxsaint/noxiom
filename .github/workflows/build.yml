name: Build Noxiom OS

on:
  push:
    branches: [ main ]

permissions:
  contents: write   # needed to create/update releases

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            nasm \
            gcc \
            binutils \
            build-essential \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            dosfstools \
            mtools

      - name: Build x86_64
        run: make ARCH=x86_64

      - name: Build arm64
        run: make ARCH=arm64

      # ── x86_64 image ──────────────────────────────────────────────────────
      # The x86_64 Makefile already produces a proper raw disk image via dd.
      - name: Collect x86_64 image
        run: |
          mkdir -p imgs
          cp noxiom/build/x86_64/noxiom.img imgs/noxiom-x86_64.img

      # ── arm64 image ───────────────────────────────────────────────────────
      # The Pi GPU bootloader needs a FAT32 partition containing:
      #   - Official Pi firmware files (start.elf, fixup.dat, etc.)
      #   - kernel8.img  (our kernel)
      #   - config.txt   (tells the GPU to load a 64-bit kernel via PL011 UART)
      # Without these firmware files the Pi ignores the SD card and shows its
      # own recovery/install screen.
      - name: Download Raspberry Pi firmware files
        run: |
          mkdir -p pi-fw
          FW="https://github.com/raspberrypi/firmware/raw/master/boot"
          for f in bootcode.bin start.elf fixup.dat start4.elf fixup4.dat \
                   start_cd.elf fixup_cd.dat; do
            echo "  Downloading $f..."
            curl -sL "$FW/$f" -o "pi-fw/$f"
          done

      - name: Create arm64 SD card image
        run: |
          # Create a 128MB image with a proper MBR partition table.
          # A raw superfloppy (no MBR) confuses the Pi 5 bootloader when the
          # SD card previously had other partitions — it sees leftover data and
          # reports "partition N unreadable".  A clean MBR with one explicit
          # FAT32 partition avoids this entirely.
          dd if=/dev/zero of=imgs/noxiom-arm64.img bs=1M count=128 status=none

          # MBR: one primary FAT32 partition starting at 1 MiB
          parted -s imgs/noxiom-arm64.img mktable msdos
          parted -s imgs/noxiom-arm64.img mkpart primary fat32 1MiB 100%

          # Format the partition in-place.
          # The partition starts at sector 2048 (1 MiB / 512 B).
          mkfs.fat -F 32 -n NOXIOM --offset 2048 imgs/noxiom-arm64.img

          # mtools can address a partition at a byte offset without root/mount.
          OFFSET=$(( 2048 * 512 ))
          echo "drive b: file=\"imgs/noxiom-arm64.img\" offset=$OFFSET" \
            > /tmp/mtoolsrc
          export MTOOLS_SKIP_CHECK=1

          cp_fat() { MTOOLSRC=/tmp/mtoolsrc mcopy -i imgs/noxiom-arm64.img@@$OFFSET "$1" "::$2"; }

          cp_fat pi-fw/bootcode.bin   bootcode.bin
          cp_fat pi-fw/start.elf      start.elf
          cp_fat pi-fw/fixup.dat      fixup.dat
          cp_fat pi-fw/start4.elf     start4.elf
          cp_fat pi-fw/fixup4.dat     fixup4.dat
          cp_fat pi-fw/start_cd.elf   start_cd.elf
          cp_fat pi-fw/fixup_cd.dat   fixup_cd.dat
          cp_fat noxiom/build/arm64/kernel8.img    kernel8.img
          # Pi 5 looks for kernel_2712.img first — provide same binary under that name
          cp_fat noxiom/build/arm64/kernel8.img    kernel_2712.img
          cp_fat noxiom/arch/arm64/boot/config.txt  config.txt

          echo "arm64 image partition contents:"
          MTOOLSRC=/tmp/mtoolsrc mdir -i imgs/noxiom-arm64.img@@$OFFSET

      # ── Publish pre-release ───────────────────────────────────────────────
      - name: Delete old nightly pre-release (if exists)
        run: gh release delete nightly --yes 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old nightly tag (if exists)
        run: git push origin :refs/tags/nightly 2>/dev/null || true

      - name: Create pre-release
        run: |
          gh release create nightly \
            imgs/noxiom-x86_64.img \
            imgs/noxiom-arm64.img \
            --title "Noxiom OS — Latest Build" \
            --notes "Automated build from commit ${{ github.sha }}

          Built on: $(date -u '+%Y-%m-%d %H:%M UTC')

          **This is a pre-release / development build.**
          Use the installer to flash to your target device." \
            --prerelease
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── Windows installer ────────────────────────────────────────────────────────
  # Publishes NoxiomInstaller.exe as a normal (non-pre-release) release so it
  # appears first on the GitHub Releases page.  The nightly .img builds remain
  # pre-releases and show up below it.
  installer:
    needs: build
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build NoxiomInstaller.exe
        run: >
          python -m PyInstaller
          --onefile --windowed --uac-admin
          --name NoxiomInstaller
          --distpath installer/dist
          --workpath installer/build
          --specpath installer
          installer/noxiom_installer.py

      - name: Delete old installer release (if exists)
        run: gh release delete installer --yes 2>$null; exit 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old installer tag (if exists)
        run: git push origin :refs/tags/installer 2>$null; exit 0

      - name: Publish installer as stable release
        run: >
          gh release create installer
          installer/dist/NoxiomInstaller.exe
          --title "Noxiom OS Installer"
          --notes "Windows installer for Noxiom OS.

          Downloads the latest OS image automatically and flashes it to your SD card or USB drive.

          **How to use:** Run NoxiomInstaller.exe as Administrator, select your target drive, choose your architecture, and click Install."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
